{{- $titleCN := resources.Get "img/title_cn.png" -}}
{{- $searchIcon := resources.Get "img/search.png" -}}
{{- $menuIcon := resources.Get "img/menu.png" -}}

<nav>
  <ul>
    <li class="site-mobile-home-item">
      <a href="{{ "/" | relURL }}" class="site-mobile-home-link" aria-label="回到主页">
        <img class="site-mobile-home-title" src="{{ $titleCN.RelPermalink }}" alt="" loading="lazy">
      </a>
    </li>
    {{- $currentPage := . -}}
    {{- $pagePath := trim $currentPage.RelPermalink "/" -}}
    {{- $benchPage := site.GetPage "/collection/bench" -}}
    {{- $officePage := site.GetPage "/collection/empa-office" -}}
    {{- $postsScratch := newScratch -}}
    {{- $postsScratch.Set "years" (slice) -}}
    {{- with site.GetPage "/posts" -}}
      {{- range sort .Pages "Date" "desc" -}}
        {{- if .PublishDate -}}
          {{- $year := .PublishDate.Year -}}
          {{- $yearKey := printf "has-year-%d" $year -}}
          {{- if not ($postsScratch.Get $yearKey) -}}
            {{- $postsScratch.Set $yearKey true -}}
            {{- $postsScratch.Add "years" (slice $year) -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}
    {{- $postYears := $postsScratch.Get "years" -}}
    {{ range site.Menus.main }}
    {{- $menuPath := trim .URL "/" -}}
    {{- $isHomeActive := and $currentPage.IsHome (eq .Identifier "home") -}}
    {{- $isDirectActive := eq $menuPath $pagePath -}}
    {{- $isSectionActive := and (ne .Identifier "home") (eq .Identifier $currentPage.Section) -}}
    <li class="nav-menu-item{{ if or (eq .Identifier "collection") (eq .Identifier "posts") }} nav-with-dropdown{{ end }}">
      <a href="{{ .URL | relLangURL }}" class="{{ if or $isHomeActive $isDirectActive $isSectionActive }}active{{ end }}">
        {{ .Name }}
      </a>
      {{ if eq .Identifier "collection" }}
        <ul class="nav-submenu" aria-label="Collection projects">
          {{ with $benchPage }}
            <li>
              <a href="{{ .RelPermalink }}" class="{{ if eq (trim .RelPermalink "/") $pagePath }}active{{ end }}">{{ .Title }}</a>
            </li>
          {{ end }}
          {{ with $officePage }}
            <li>
              <a href="{{ .RelPermalink }}" class="{{ if eq (trim .RelPermalink "/") $pagePath }}active{{ end }}">{{ .Title }}</a>
            </li>
          {{ end }}
        </ul>
      {{ else if and (eq .Identifier "posts") (gt (len $postYears) 0) }}
        <ul class="nav-submenu" aria-label="Posts years">
          {{ range $postYears }}
            <li>
              <a href="{{ (printf "/posts/#posts-year-%d" .) | relLangURL }}">{{ . }}</a>
            </li>
          {{ end }}
        </ul>
      {{ end }}
    </li>
    {{ end }}
    <li class="nav-theme-item nav-tools-item">
      {{ partial "header/theme-button" . }}
      <button
        type="button"
        class="site-search-toggle site-desktop-search-toggle"
        data-site-search-open
        data-hover-tooltip="虫眼鏡"
        data-hover-tooltip-delay="1000"
        aria-label="打开搜索"
        aria-expanded="false"
      >
        <img class="site-search-icon" src="{{ $searchIcon.RelPermalink }}" alt="" loading="lazy">
      </button>
    </li>
    <li class="site-mobile-menu-item">
      <button
        type="button"
        class="site-mobile-menu-toggle"
        aria-expanded="false"
        aria-controls="site-mobile-menu-panel"
        aria-label="展开导航菜单"
      >
        <img class="site-mobile-menu-icon" src="{{ $menuIcon.RelPermalink }}" alt="" loading="lazy">
      </button>
    </li>
  </ul>
  <div class="site-mobile-menu-panel" id="site-mobile-menu-panel" hidden>
    <div class="site-mobile-menu-scroll">
      <ul class="site-mobile-menu-list" aria-label="Mobile navigation">
        {{ range site.Menus.main }}
        {{- $menuPath := trim .URL "/" -}}
        {{- $isHomeActive := and $currentPage.IsHome (eq .Identifier "home") -}}
        {{- $isDirectActive := eq $menuPath $pagePath -}}
        {{- $isSectionActive := and (ne .Identifier "home") (eq .Identifier $currentPage.Section) -}}
        <li class="site-mobile-menu-line">
          <a href="{{ .URL | relLangURL }}" class="{{ if or $isHomeActive $isDirectActive $isSectionActive }}active{{ end }}">{{ .Name }}</a>
        </li>
        {{ end }}
        <li class="site-mobile-menu-line site-mobile-search-line">
          <button
            type="button"
            class="site-mobile-search-toggle"
            data-site-search-open
            data-hover-tooltip="虫眼鏡"
            data-hover-tooltip-delay="1000"
            aria-label="打开搜索"
            aria-expanded="false"
          >
            <img class="site-search-icon" src="{{ $searchIcon.RelPermalink }}" alt="" loading="lazy">
          </button>
        </li>
      </ul>
    </div>
  </div>
  <div class="site-search-modal" id="site-search-modal" data-index-url="{{ "index.json" | relURL }}" hidden>
    <div class="site-search-backdrop" data-site-search-close></div>
    <section class="site-search-dialog" role="dialog" aria-modal="true" aria-label="Site search">
      <div class="site-search-input-wrap">
        <input id="site-search-input" class="site-search-input" type="search" placeholder="在意的关键词是……" autocomplete="off">
      </div>
      <ul id="site-search-results" class="site-search-results" aria-label="Search results"></ul>
    </section>
  </div>
</nav>
