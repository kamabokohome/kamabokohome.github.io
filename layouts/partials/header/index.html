{{- $dayBack := resources.Get "img/day_back.png" -}}
{{- $nightBack := resources.Get "img/night_back.png" -}}
{{- $dayFront := resources.Get "img/day_front.png" -}}
{{- $nightFront := resources.Get "img/night_front.png" -}}
{{- $titleDayFallback := resources.Get "img/title_day.png" -}}
{{- $titleNightFallback := resources.Get "img/title_night.png" -}}
{{- $titleDayFrontFallback := resources.Get "img/title_day1.png" -}}
{{- $titleNightFrontFallback := resources.Get "img/title_night1.png" -}}

<header class="flex flex-col w-full gap-3">
  <div class="w-full flex justify-center">
    <a href="{{ "/" | relURL }}" class="title-interactive" aria-label="Site title image">
      <div class="title-water-layer" aria-hidden="true"></div>
      <img
        src="{{ $dayBack.RelPermalink }}"
        class="title-back-day-src"
        style="display:none;"
        aria-hidden="true"
        onerror="this.onerror=null;this.src='{{ $titleDayFallback.RelPermalink }}';"
      >
      <img
        src="{{ $nightBack.RelPermalink }}"
        class="title-back-night-src"
        style="display:none;"
        aria-hidden="true"
        onerror="this.onerror=null;this.src='{{ $titleNightFallback.RelPermalink }}';"
      >
      <img
        src="{{ $dayFront.RelPermalink }}"
        class="title-front-day"
        style="display:block;"
        onerror="this.onerror=null;this.src='{{ $titleDayFrontFallback.RelPermalink }}';"
      >
      <img
        src="{{ $nightFront.RelPermalink }}"
        class="title-front-night"
        style="display:none;"
        onerror="this.onerror=null;this.src='{{ $titleNightFrontFallback.RelPermalink }}';"
      >
    </a>
  </div>
</header>

<style>
  .title-interactive {
    position: relative;
    display: inline-block;
    line-height: 0;
    overflow: hidden;
  }

  .title-interactive .title-water-layer {
    position: absolute;
    inset: 0;
    background-repeat: no-repeat;
    background-position: center;
    background-size: contain;
    z-index: 1;
  }

  .title-interactive .title-front-day,
  .title-interactive .title-front-night {
    display: block;
    position: relative;
    z-index: 2;
    pointer-events: none;
  }
</style>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const title = document.querySelector(".title-interactive");
    const waterLayer = title ? title.querySelector(".title-water-layer") : null;
    const root = document.documentElement;
    const dayFront = title ? title.querySelector(".title-front-day") : null;
    const nightFront = title ? title.querySelector(".title-front-night") : null;
    const dayBack = title ? title.querySelector(".title-back-day-src") : null;
    const nightBack = title ? title.querySelector(".title-back-night-src") : null;
    if (!title || !waterLayer || !dayFront || !nightFront || !dayBack || !nightBack) return;
    const TITLE_RIPPLE_ENABLED = false;
    const hasRipples = TITLE_RIPPLE_ENABLED && !!(window.jQuery && window.jQuery.fn && window.jQuery.fn.ripples);
    const LIGHT_PERTURBANCE = 0.052;
    const DARK_PERTURBANCE = 0.044;
    const $water = hasRipples ? window.jQuery(waterLayer) : null;

    const getCurrentBackSrc = function () {
      const back = root.classList.contains("dark") ? nightBack : dayBack;
      return (back && (back.currentSrc || back.getAttribute("src"))) || "";
    };

    const syncTitleRippleImage = function () {
      const isDark = root.classList.contains("dark");
      dayFront.style.display = isDark ? "none" : "block";
      nightFront.style.display = isDark ? "block" : "none";

      if ($water && $water.data("ripples")) {
        try {
          $water.ripples("set", "perturbance", isDark ? DARK_PERTURBANCE : LIGHT_PERTURBANCE);
        } catch (_) {}
      }

      const src = getCurrentBackSrc();
      if (!src) return;
      if ($water && $water.data("ripples")) {
        try {
          $water.ripples("set", "imageUrl", src);
        } catch (_) {}
      } else {
        waterLayer.style.backgroundImage = "url('" + src + "')";
      }
    };

    syncTitleRippleImage();

    if (hasRipples) {
      try {
        $water.ripples({
          resolution: 256,
          dropRadius: 24,
          perturbance: root.classList.contains("dark") ? DARK_PERTURBANCE : LIGHT_PERTURBANCE,
          interactive: true,
          crossOrigin: ""
        });
        syncTitleRippleImage();
        const rect = title.getBoundingClientRect();
        if (rect.width > 0 && rect.height > 0) {
          $water.ripples("drop", rect.width * 0.5, rect.height * 0.52, 26, 0.18);
          $water.ripples("drop", rect.width * 0.32, rect.height * 0.68, 18, 0.11);
        }
      } catch (_) {}

      let lastMoveDropAt = 0;
      const dropAtPointer = function (event, radius, strength) {
        if (!$water.data("ripples")) return;
        const rect = title.getBoundingClientRect();
        if (rect.width <= 0 || rect.height <= 0) return;
        const x = event.clientX - rect.left;
        const y = event.clientY - rect.top;
        if (x < 0 || y < 0 || x > rect.width || y > rect.height) return;
        try {
          $water.ripples("drop", x, y, radius, strength);
        } catch (_) {}
      };

      title.addEventListener("pointermove", function (event) {
        const now = Date.now();
        if (now - lastMoveDropAt < 28) return;
        lastMoveDropAt = now;
        dropAtPointer(event, 13, 0.03);
      }, { passive: true });

      title.addEventListener("pointerdown", function (event) {
        if (event.button !== 0) return;
        dropAtPointer(event, 24, 0.17);
      }, { passive: true });

    }

    const observer = new MutationObserver(syncTitleRippleImage);
    observer.observe(root, { attributes: true, attributeFilter: ["class"] });
    window.setTitleRippleImage = syncTitleRippleImage;
  });
</script>
