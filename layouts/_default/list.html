{{ define "main" }}

{{ $pages := .Pages }}
{{/* {{ $paginator := .Paginate $pages }} */}}

<!--
<div class="flex flex-col">
  {{ if .Title }}
    <h2 class="text-lg font-extrabold">
      {{ .Title }}
    </h2>
  {{ end }}
</div>
-->

{{ with .Content }}
  <div class="content" style="padding-top: 0.5rem;">
    {{ . }}
  </div>
{{ end }}

{{ if and (eq .Section "collection") (eq .Kind "section") }}
  {{ $benchPage := .Site.GetPage "/collection/bench" }}
  {{ $officePage := .Site.GetPage "/collection/empa-office" }}
  <section class="collection-banner-list" aria-label="Collection projects">
    {{ with $benchPage }}
      {{ $banner := .Resources.GetMatch "250501.*" }}
      <a class="collection-banner-card" href="{{ .RelPermalink }}">
        {{ with $banner }}
          <img
            class="collection-banner-image"
            src="{{ .RelPermalink }}"
            alt="{{ $benchPage.Title }} banner"
            loading="lazy"
            style="object-position: 50% 100%;"
          />
        {{ end }}
        <span class="collection-banner-frost" aria-hidden="true"></span>
        <span class="collection-banner-mask" aria-hidden="true"></span>
        <span class="collection-banner-copy">
          <span class="collection-banner-title">{{ .Title }}</span>
          {{ with .Params.description }}
            <span class="collection-banner-description">{{ . }}</span>
          {{ end }}
        </span>
      </a>
    {{ end }}

    {{ with $officePage }}
      {{ $banner := .Resources.GetMatch "IMG_0001.*" }}
      <a class="collection-banner-card" href="{{ .RelPermalink }}">
        {{ with $banner }}
          <img
            class="collection-banner-image"
            src="{{ .RelPermalink }}"
            alt="{{ $officePage.Title }} banner"
            loading="lazy"
            style="object-position: 50% 78%;"
          />
        {{ end }}
        <span class="collection-banner-frost" aria-hidden="true"></span>
        <span class="collection-banner-mask" aria-hidden="true"></span>
        <span class="collection-banner-copy">
          <span class="collection-banner-title">{{ .Title }}</span>
          {{ with .Params.description }}
            <span class="collection-banner-description">{{ . }}</span>
          {{ end }}
        </span>
      </a>
    {{ end }}
  </section>
{{ else if and (eq .Section "corner") (eq .Kind "section") }}
  {{ $cornerPages := slice }}
  {{ range readDir "content/corner" }}
    {{ if and (not .IsDir) (hasSuffix .Name ".md") (ne .Name "_index.md") }}
      {{ $pagePath := printf "/corner/%s" (replaceRE "\\.md$" "" .Name) }}
      {{ with $.Site.GetPage $pagePath }}
        {{ $cornerPages = $cornerPages | append . }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ $cornerPages = sort $cornerPages "Date" "desc" }}
  <section class="corner-entry-list" aria-label="Corner entries">
    {{ range $cornerPages }}
      <details class="corner-entry-item">
        <summary class="corner-entry-summary">
          <span class="corner-entry-title">{{ .Title }}</span>
          {{ with .Date }}
            <time class="corner-entry-date" datetime="{{ .Format "2006-01-02T15:04:05Z07:00" }}">{{ .Format "2006-01-02" }}</time>
          {{ end }}
        </summary>
        <div class="corner-entry-body">
          {{ .Content }}
        </div>
      </details>
    {{ end }}
  </section>
{{ else if and (eq .Section "message") (eq .Kind "section") }}
  {{ $messageFormConfig := .Site.Params.messageForm }}
  {{ $messageActionURL := "" }}
  {{ with $messageFormConfig.actionURL }}
    {{ $messageActionURL = . }}
  {{ end }}
  {{ $messageSubject := "Kamaboko Home Message" }}
  {{ with $messageFormConfig.subject }}
    {{ $messageSubject = . }}
  {{ end }}
  <section
    class="message-board"
    data-message-board
    data-message-action="{{ $messageActionURL }}"
  >
    <form class="message-form" data-message-form autocomplete="off" method="POST" accept-charset="UTF-8" action="{{ $messageActionURL }}" onsubmit="var n=this.querySelector('[data-message-next]');if(n){n.value=window.location.origin+window.location.pathname+'?sent=1&t='+Date.now();}">
      <input type="hidden" name="_subject" value="{{ $messageSubject }}" />
      <input type="hidden" name="_captcha" value="false" />
      <input type="hidden" name="_next" value="" data-message-next />
      <div class="message-form-row">
        <label for="guestbook-content">ä¿¡çš„å†…å®¹</label>
        <textarea id="guestbook-content" name="message" rows="6" maxlength="500" placeholder="ä¼¼ä¹æœ‰ä»€ä¹ˆæƒ³è¯´çš„æ ·å­" required></textarea>
      </div>
      <div class="message-form-row">
        <label for="guestbook-signature">è½æ¬¾</label>
        <input id="guestbook-signature" name="signature" type="text" maxlength="24" placeholder="é¦™ç”œçš„å¹´è½®è›‹ç³•" />
      </div>
      <div class="message-form-row">
        <label for="guestbook-reply">å›ä¿¡åœ°å€</label>
        <input id="guestbook-reply" name="reply_address" type="text" maxlength="120" placeholder="ä¸å†™ä¹Ÿæ²¡å…³ç³»ï¼Œå†™äº†ä¹Ÿä¸ä¸€å®šä¼šæ”¶åˆ°å›ä¿¡çš„æ ·å­" />
      </div>
      <div class="message-form-actions">
        <button class="message-submit-button" type="submit">å¯„å‡º</button>
      </div>
      <p class="message-board-status" data-message-status aria-live="polite"></p>
    </form>
    <p class="message-board-note" data-message-note></p>
  </section>
{{ else }}
  {{ $isPostsSection := and (eq .Section "posts") (eq .Kind "section") }}
  {{ $postYears := slice }}
  {{ if $isPostsSection }}
    {{ $prevPickerYear := 0 }}
    {{ range $pages }}
      {{ if .PublishDate }}
        {{ $pickerYear := .PublishDate.Year }}
        {{ if ne $pickerYear $prevPickerYear }}
          {{ $postYears = $postYears | append $pickerYear }}
          {{ $prevPickerYear = $pickerYear }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  <section class="section-list-default">
    {{ $prevYear := 0 }}
    {{ range $index, $page := $pages }}
      {{ if $page.PublishDate }}
        {{ $year := $page.PublishDate.Year }}

        {{ if ne $year $prevYear }}
        {{ $yearAnchorID := printf "year-%d" $year }}
        {{ if eq $.Section "posts" }}
          {{ $yearAnchorID = printf "posts-year-%d" $year }}
        {{ end }}
        {{ if and $isPostsSection (gt (len $postYears) 0) }}
          {{ $currentPostsYear := $year }}
          <div id="{{ $yearAnchorID }}" data-posts-year="{{ $year }}" class="year-separator flex justify-center items-center text-xs font-semibold text-gray-400 dark:text-gray-400 my-2 posts-year-separator"
          style="margin-top:1rem; margin-bottom:1rem; scroll-margin-top: 5rem;">
            <details class="posts-year-dropdown">
              <summary class="posts-year-trigger">ï½ {{ $year }} ï½</summary>
              <div class="posts-year-jump-menu" role="menu" aria-label="Posts years">
                {{ range $postYears }}
                  <a role="menuitem" href="#posts-year-{{ . }}"{{ if eq . $currentPostsYear }} class="is-current" aria-current="true"{{ end }}>{{ . }}</a>
                {{ end }}
              </div>
            </details>
          </div>
        {{ else }}
          <div id="{{ $yearAnchorID }}" class="year-separator flex justify-center items-center text-xs font-semibold text-gray-400 dark:text-gray-400 my-2"
          style="margin-top:1rem; margin-bottom:1rem; scroll-margin-top: 5rem;">
                    ï½ {{ $year }} ï½
            </div>
        {{ end }}
          {{ $prevYear = $year }}
        {{ end }}
      {{ end }}

      {{ partial "list/default" $page }}
    {{ end }}
  </section>
{{ end }}


{{/*
{{ if gt $paginator.TotalPages 1 }}
  {{ partial "list/pagination" . }}
{{ end }}
*/}}

<div class="flex justify-center" style="margin-top: auto; padding-top: 1rem;">
  <a href="#" onclick="scrollToTop()" class="pagination-button text-xs font-semibold" style="color: #9CA3AF; text-decoration: none; cursor: pointer;">
    TğŸ¥P
  </a>
</div>

<script>
  const backToTopBtn = document.getElementById('backToTop');
  if (backToTopBtn) {
    backToTopBtn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // é¡µé¢æ»šåŠ¨æ—¶æ˜¾ç¤ºæˆ–éšè—æŒ‰é’®
    window.addEventListener('scroll', () => {
      if (window.scrollY > 200) {
        backToTopBtn.style.display = 'block';
      } else {
        backToTopBtn.style.display = 'none';
      }
    });

    // åˆå§‹éšè—æŒ‰é’®
    backToTopBtn.style.display = 'none';
  }

  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  const messageBoard = document.querySelector('[data-message-board]');
  if (messageBoard) {
    const form = messageBoard.querySelector('[data-message-form]');
    const contentInput = messageBoard.querySelector('#guestbook-content');
    const signatureInput = messageBoard.querySelector('#guestbook-signature');
    const replyInput = messageBoard.querySelector('#guestbook-reply');
    const note = messageBoard.querySelector('[data-message-note]');
    const status = messageBoard.querySelector('[data-message-status]');
    const submitButton = form ? form.querySelector('button[type="submit"]') : null;
    const nextInput = form ? form.querySelector('[data-message-next]') : null;
    const formAction = form ? (form.getAttribute('action') || '').trim() : '';
    const hasAction = formAction.length > 0;

    const normalizeNickname = (value) => value.trim().replace(/\s+/g, ' ').slice(0, 24);
    const normalizeMessage = (value) => value.trim().slice(0, 500);

    const setStatus = (text, tone = 'normal') => {
      if (!status) return;
      status.textContent = text || '';
      status.dataset.tone = tone;
      status.hidden = !text;
    };

    const setSubmitting = (isSubmitting) => {
      if (!submitButton) return;
      submitButton.disabled = isSubmitting;
      submitButton.setAttribute('aria-busy', isSubmitting ? 'true' : 'false');
    };

    if (note) {
      note.textContent = hasAction
        ? 'å¡«å†™åä¼šå‘é€åˆ°ç«™é•¿é‚®ç®±ã€‚è‹¥æœªæ”¶åˆ°ï¼Œè¯·æ£€æŸ¥å¹¶æ¿€æ´» FormSubmit ç¡®è®¤é‚®ä»¶ã€‚'
        : 'å½“å‰æœªé…ç½®é‚®ä»¶å‘é€åœ°å€ã€‚';
    }

    if (status) {
      status.hidden = true;
    }

    const url = new URL(window.location.href);
    const isSent = url.searchParams.get('sent') === '1';
    if (isSent) {
      const sentMsRaw = url.searchParams.get('t');
      const sentMs = sentMsRaw ? Number(sentMsRaw) : NaN;
      const sentDate = Number.isFinite(sentMs) && sentMs > 0 ? new Date(sentMs) : new Date();
      const sentAtText = sentDate.toLocaleString();
      setStatus(`ä¿¡ä»¶å·²ç»å¯„å‡ºäº†ï¼ï¼ˆ${sentAtText}ï¼‰`, 'success');
      url.searchParams.delete('sent');
      url.searchParams.delete('t');
      window.history.replaceState({}, '', url.toString());
    }

    if (!hasAction) {
      if (form) {
        form.setAttribute('aria-disabled', 'true');
      }
      if (contentInput) contentInput.disabled = true;
      if (signatureInput) signatureInput.disabled = true;
      if (replyInput) replyInput.disabled = true;
      setSubmitting(true);
      setStatus('è¯·å…ˆåœ¨ç«™ç‚¹é…ç½®ä¸­å¡«å†™é‚®ä»¶è¡¨å•åœ°å€ã€‚', 'error');
      return;
    }

    if (!form) return;
    form.addEventListener('submit', async (event) => {
      const content = contentInput ? normalizeMessage(contentInput.value) : '';
      const signature = signatureInput ? (normalizeNickname(signatureInput.value) || 'é¦™ç”œçš„å¹´è½®è›‹ç³•') : 'é¦™ç”œçš„å¹´è½®è›‹ç³•';
      const replyAddress = replyInput ? replyInput.value.trim().slice(0, 120) : '';
      if (!content) {
        event.preventDefault();
        setStatus('è¯·å¡«å†™ç•™è¨€å†…å®¹ã€‚', 'error');
        return;
      }

      if (nextInput) {
        const base = `${window.location.origin}${window.location.pathname}`;
        const nextURL = `${base}?sent=1&t=${Date.now()}`;
        nextInput.value = nextURL;
      }

      event.preventDefault();
      if (contentInput) contentInput.value = content;
      if (signatureInput) signatureInput.value = signature;
      if (replyInput) replyInput.value = replyAddress;
      setSubmitting(true);
      setStatus('æ­£åœ¨å‘é€ï¼Œè¯·ç¨å€™...', 'normal');

      try {
        const ajaxAction = formAction.includes('/ajax/')
          ? formAction
          : formAction.replace('://formsubmit.co/', '://formsubmit.co/ajax/');
        const payload = new FormData(form);
        const response = await fetch(ajaxAction, {
          method: 'POST',
          headers: {
            Accept: 'application/json'
          },
          body: payload
        });
        const result = await response.json().catch(() => ({}));

        if (!response.ok) {
          const errorText = (result && typeof result.message === 'string' && result.message.trim())
            ? result.message.trim()
            : `å‘é€å¤±è´¥ï¼ˆ${response.status}ï¼‰`;
          setStatus(errorText, 'error');
          return;
        }

        const sentAtText = new Date().toLocaleString();
        setStatus(`ä¿¡ä»¶å·²ç»å¯„å‡ºäº†ï¼ï¼ˆ${sentAtText}ï¼‰`, 'success');
        if (contentInput) contentInput.value = '';
      } catch (error) {
        setStatus('å‘é€å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•ã€‚', 'error');
      } finally {
        setSubmitting(false);
      }
    });
  }

</script>

{{ end }}
