{{ define "main" }}

{{ $pages := .Pages }}
{{ $cornerPages := slice }}
{{/* {{ $paginator := .Paginate $pages }} */}}

<!--
<div class="flex flex-col">
  {{ if .Title }}
    <h2 class="text-lg font-extrabold">
      {{ .Title }}
    </h2>
  {{ end }}
</div>
-->

{{ with .Content }}
  <div class="content" style="padding-top: 0.5rem;">
    {{ . }}
  </div>
{{ end }}

{{ if and (eq .Section "collection") (eq .Kind "section") }}
  {{ $benchPage := .Site.GetPage "/collection/bench" }}
  {{ $officePage := .Site.GetPage "/collection/empa-office" }}
  <section class="collection-banner-list" aria-label="Collection projects">
    {{ with $benchPage }}
      {{ $banner := .Resources.GetMatch "250501.*" }}
      <a class="collection-banner-card" href="{{ .RelPermalink }}">
        {{ with $banner }}
          <img
            class="collection-banner-image"
            src="{{ .RelPermalink }}"
            alt="{{ $benchPage.Title }} banner"
            loading="lazy"
            style="object-position: 50% 100%;"
          />
        {{ end }}
        <span class="collection-banner-frost" aria-hidden="true"></span>
        <span class="collection-banner-mask" aria-hidden="true"></span>
        <span class="collection-banner-copy">
          <span class="collection-banner-title">{{ .Title }}</span>
          {{ with .Params.description }}
            <span class="collection-banner-description">{{ . }}</span>
          {{ end }}
        </span>
      </a>
    {{ end }}

    {{ with $officePage }}
      {{ $banner := .Resources.GetMatch "IMG_0001.*" }}
      <a class="collection-banner-card" href="{{ .RelPermalink }}">
        {{ with $banner }}
          <img
            class="collection-banner-image"
            src="{{ .RelPermalink }}"
            alt="{{ $officePage.Title }} banner"
            loading="lazy"
            style="object-position: 50% 78%;"
          />
        {{ end }}
        <span class="collection-banner-frost" aria-hidden="true"></span>
        <span class="collection-banner-mask" aria-hidden="true"></span>
        <span class="collection-banner-copy">
          <span class="collection-banner-title">{{ .Title }}</span>
          {{ with .Params.description }}
            <span class="collection-banner-description">{{ . }}</span>
          {{ end }}
        </span>
      </a>
    {{ end }}
  </section>
{{ else if and (eq .Section "corner") (eq .Kind "section") }}
  {{ range readDir "content/corner" }}
    {{ if and (not .IsDir) (hasSuffix .Name ".md") (ne .Name "_index.md") }}
      {{ $pagePath := printf "/corner/%s" (replaceRE "\\.md$" "" .Name) }}
      {{ with $.Site.GetPage $pagePath }}
        {{ $cornerPages = $cornerPages | append . }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ $cornerPages = sort $cornerPages "Date" "desc" }}
  {{ $cornerTags := slice }}
  {{ range $cornerPage := $cornerPages }}
    {{ with $cornerPage.Params.tags }}
      {{ range . }}
        {{ $cornerTags = $cornerTags | append (printf "%v" .) }}
      {{ end }}
    {{ end }}
  {{ end }}
  {{ $cornerTags = sort (uniq $cornerTags) }}
  {{ if gt (len $cornerTags) 0 }}
    <section class="collection-layout-switch corner-tag-switch" role="group" aria-label="Corner tag filter">
      <button type="button" class="collection-layout-btn is-active" data-corner-tag="all">All</button>
      {{ range $tag := $cornerTags }}
        <button type="button" class="collection-layout-btn" data-corner-tag="{{ $tag | urlize }}">{{ $tag }}</button>
      {{ end }}
    </section>
  {{ end }}
  <section class="corner-entry-list" id="corner-entry-list" aria-label="Corner entries">
    {{ range $idx, $cornerPage := $cornerPages }}
      {{ $entryKey := md5 $cornerPage.RelPermalink }}
      {{ $entryID := printf "corner-entry-%s" $entryKey }}
      {{ $entryTagSlugs := slice }}
      {{ with $cornerPage.Params.tags }}
        {{ range . }}
          {{ $entryTagSlugs = $entryTagSlugs | append ((printf "%v" .) | urlize) }}
        {{ end }}
      {{ end }}
      <details class="corner-entry-item" id="{{ $entryID }}" data-corner-entry data-corner-tags="{{ delimit $entryTagSlugs "|" }}">
        <summary class="corner-entry-summary">
          <span class="corner-entry-title">{{ $cornerPage.Title }}</span>
          {{ with $cornerPage.Date }}
            <time class="corner-entry-date" datetime="{{ .Format "2006-01-02T15:04:05Z07:00" }}">{{ .Format "2006-01-02" }}</time>
          {{ end }}
        </summary>
        <div class="corner-entry-body">
          {{ $cornerPage.Content }}
          {{ with $cornerPage.Params.tags }}
            <div class="corner-entry-tags" aria-label="Entry tags">
              {{ range . }}
                <button type="button" class="collection-layout-btn corner-entry-tag" data-corner-entry-tag="{{ (printf "%v" .) | urlize }}">{{ . }}</button>
              {{ end }}
            </div>
          {{ end }}
        </div>
      </details>
    {{ end }}
  </section>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const tagButtons = Array.from(document.querySelectorAll(".corner-tag-switch .collection-layout-btn[data-corner-tag]"));
      const entryTagButtons = Array.from(document.querySelectorAll(".corner-entry-tag[data-corner-entry-tag]"));
      const cornerEntries = Array.from(document.querySelectorAll("[data-corner-entry]"));
      const cornerList = document.getElementById("corner-entry-list");
      const filterStorageKey = "corner-tag-filter";

      const setActiveTagButton = function(tag) {
        tagButtons.forEach(function(button) {
          button.classList.toggle("is-active", (button.getAttribute("data-corner-tag") || "all") === tag);
        });
      };

      const foldAllCornerEntries = function() {
        cornerEntries.forEach(function(entry) {
          entry.open = false;
        });
      };

      const applyTagFilter = function(tag) {
        const activeTag = tag || "all";
        foldAllCornerEntries();
        cornerEntries.forEach(function(entry) {
          const tags = (entry.getAttribute("data-corner-tags") || "")
            .split("|")
            .filter(Boolean);
          const visible = activeTag === "all" || tags.indexOf(activeTag) >= 0;
          entry.hidden = !visible;
        });
        setActiveTagButton(activeTag);
        try {
          if (activeTag && activeTag !== "all") {
            window.localStorage.setItem(filterStorageKey, activeTag);
          } else {
            window.localStorage.removeItem(filterStorageKey);
          }
        } catch (e) {}
      };

      if (tagButtons.length > 0) {
        let initialTag = "all";
        try {
          const storedTag = window.localStorage.getItem(filterStorageKey);
          const hasStoredTagButton = tagButtons.some(function(button) {
            return button.getAttribute("data-corner-tag") === storedTag;
          });
          if (storedTag && hasStoredTagButton) {
            initialTag = storedTag;
          }
        } catch (e) {}
        applyTagFilter(initialTag);
        tagButtons.forEach(function(button) {
          button.addEventListener("click", function() {
            const tag = button.getAttribute("data-corner-tag") || "all";
            const isActive = button.classList.contains("is-active");
            if (isActive && tag !== "all") {
              applyTagFilter("all");
              return;
            }
            applyTagFilter(tag);
          });
        });
      }

      if (entryTagButtons.length > 0) {
        entryTagButtons.forEach(function(button) {
          button.addEventListener("click", function() {
            const tag = button.getAttribute("data-corner-entry-tag") || "all";
            applyTagFilter(tag);
            window.requestAnimationFrame(function() {
              if (!cornerList) return;
              cornerList.scrollIntoView({ block: "start", behavior: "smooth" });
            });
          });
        });
      }

      const openCornerFromHash = function() {
        if (!window.location.hash) return;
        const rawId = window.location.hash.slice(1);
        if (!rawId) return;
        const entry = document.getElementById(rawId);
        if (!entry || !entry.matches("[data-corner-entry]")) return;
        if (entry.hidden) applyTagFilter("all");
        entry.open = true;
        window.requestAnimationFrame(function() {
          entry.scrollIntoView({ block: "start", behavior: "smooth" });
        });
      };

      openCornerFromHash();
      window.addEventListener("hashchange", openCornerFromHash);
    });
  </script>
{{ else if and (eq .Section "message") (eq .Kind "section") }}
  {{ $messageFormConfig := .Site.Params.messageForm }}
  {{ $messageActionURL := "" }}
  {{ with $messageFormConfig.actionURL }}
    {{ $messageActionURL = . }}
  {{ end }}
  {{ $messageSubject := "Kamaboko Home Message" }}
  {{ with $messageFormConfig.subject }}
    {{ $messageSubject = . }}
  {{ end }}
  {{ $messageTemplate := "table" }}
  {{ with $messageFormConfig.template }}
    {{ $messageTemplate = . }}
  {{ end }}
  <section
    class="message-board"
    data-message-board
    data-message-action="{{ $messageActionURL }}"
  >
    <form class="message-form" data-message-form autocomplete="off" method="POST" accept-charset="UTF-8" action="{{ $messageActionURL }}" onsubmit="var n=this.querySelector('[data-message-next]');if(n){n.value=window.location.origin+window.location.pathname+'?sent=1&t='+Date.now();}">
      <input type="hidden" name="_subject" value="{{ $messageSubject }}" />
      <input type="hidden" name="_template" value="{{ $messageTemplate }}" />
      <input type="hidden" name="_captcha" value="false" />
      <input type="hidden" name="_next" value="" data-message-next />
      <input type="hidden" name="_replyto" value="" data-message-replyto />
      <input type="hidden" name="Êèê‰∫§Êó∂Èó¥" value="" data-message-submitted-local />
      <input type="hidden" name="Êèê‰∫§Êó∂Âå∫" value="" data-message-timezone />
      <div class="message-form-row">
        <label for="guestbook-content">‰ø°ÁöÑÂÜÖÂÆπ</label>
        <textarea id="guestbook-content" name="‰ø°ÁöÑÂÜÖÂÆπ" rows="8" maxlength="500" placeholder="‰ºº‰πéÊúâ‰ªÄ‰πàÊÉ≥ËØ¥ÁöÑÊ†∑Â≠ê" required></textarea>
      </div>
      <div class="message-form-row">
        <label for="guestbook-signature">ËêΩÊ¨æ</label>
        <input id="guestbook-signature" name="ËêΩÊ¨æ" type="text" maxlength="24" placeholder="È¶ôÁîúÁöÑÂπ¥ËΩÆËõãÁ≥ï" />
      </div>
      <div class="message-form-row">
        <label for="guestbook-reply">Âõû‰ø°Âú∞ÂùÄ</label>
        <input id="guestbook-reply" name="Âõû‰ø°Âú∞ÂùÄ" type="email" inputmode="email" autocomplete="email" autocapitalize="off" spellcheck="false" maxlength="120" placeholder="ËØ¥‰∏çÂÆö‰ºöÊúâÂõû‰ø°ÁöÑÊ†∑Â≠ê" />
      </div>
      <p class="message-board-status" data-message-status aria-live="polite"></p>
      <div class="message-form-actions">
        <button class="message-submit-button" type="submit" data-label-default="ÂÜôÂ•Ω‰∫Ü" data-label-confirm="Á°ÆËÆ§Â•Ω‰∫ÜÔºÅ">ÂÜôÂ•Ω‰∫Ü</button>
      </div>
    </form>
  </section>
{{ else }}
  {{ $isPostsSection := and (eq .Section "posts") (eq .Kind "section") }}
  {{ $postYears := slice }}
  {{ if $isPostsSection }}
    {{ $prevPickerYear := 0 }}
    {{ range $pages }}
      {{ if .PublishDate }}
        {{ $pickerYear := .PublishDate.Year }}
        {{ if ne $pickerYear $prevPickerYear }}
          {{ $postYears = $postYears | append $pickerYear }}
          {{ $prevPickerYear = $pickerYear }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  <section class="section-list-default">
    {{ $prevYear := 0 }}
    {{ range $index, $page := $pages }}
      {{ if $page.PublishDate }}
        {{ $year := $page.PublishDate.Year }}

        {{ if ne $year $prevYear }}
        {{ $yearAnchorID := printf "year-%d" $year }}
        {{ if eq $.Section "posts" }}
          {{ $yearAnchorID = printf "posts-year-%d" $year }}
        {{ end }}
        {{ if and $isPostsSection (gt (len $postYears) 0) }}
          {{ $currentPostsYear := $year }}
          <div id="{{ $yearAnchorID }}" data-posts-year="{{ $year }}" class="year-separator flex justify-center items-center text-xs font-semibold text-gray-400 dark:text-gray-400 my-2 posts-year-separator"
          style="margin-top:1rem; margin-bottom:1rem; scroll-margin-top: 5rem;">
            <details class="posts-year-dropdown">
              <summary class="posts-year-trigger">ÔΩû {{ $year }} ÔΩû</summary>
              <div class="posts-year-jump-menu" role="menu" aria-label="Posts years">
                {{ range $postYears }}
                  <a role="menuitem" href="#posts-year-{{ . }}"{{ if eq . $currentPostsYear }} class="is-current" aria-current="true"{{ end }}>{{ . }}</a>
                {{ end }}
              </div>
            </details>
          </div>
        {{ else }}
          <div id="{{ $yearAnchorID }}" class="year-separator flex justify-center items-center text-xs font-semibold text-gray-400 dark:text-gray-400 my-2"
          style="margin-top:1rem; margin-bottom:1rem; scroll-margin-top: 5rem;">
                    ÔΩû {{ $year }} ÔΩû
            </div>
        {{ end }}
          {{ $prevYear = $year }}
        {{ end }}
      {{ end }}

      {{ partial "list/default" $page }}
    {{ end }}
  </section>
{{ end }}


{{/*
{{ if gt $paginator.TotalPages 1 }}
  {{ partial "list/pagination" . }}
{{ end }}
*/}}

<div class="flex justify-center" style="margin-top: auto; padding-top: 1rem;">
  <button type="button" onclick="{{ if and (eq .Section "corner") (eq .Kind "section") }}foldCornerEntries(){{ else }}scrollToTop(){{ end }}" class="pagination-button text-xs font-semibold" style="color: #9CA3AF; text-decoration: none; cursor: pointer; background: none; border: none;">
    {{ if and (eq .Section "corner") (eq .Kind "section") }}Füç•LD{{ else }}Tüç•P{{ end }}
  </button>
</div>

<script>
  const backToTopBtn = document.getElementById('backToTop');
  if (backToTopBtn) {
    backToTopBtn.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // È°µÈù¢ÊªöÂä®Êó∂ÊòæÁ§∫ÊàñÈöêËóèÊåâÈíÆ
    window.addEventListener('scroll', () => {
      if (window.scrollY > 200) {
        backToTopBtn.style.display = 'block';
      } else {
        backToTopBtn.style.display = 'none';
      }
    });

    // ÂàùÂßãÈöêËóèÊåâÈíÆ
    backToTopBtn.style.display = 'none';
  }

  function scrollToTop() {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function foldCornerEntries() {
    const entries = document.querySelectorAll('[data-corner-entry]');
    entries.forEach((entry) => {
      entry.open = false;
    });
  }

  const messageBoard = document.querySelector('[data-message-board]');
  if (messageBoard) {
    const form = messageBoard.querySelector('[data-message-form]');
    const contentInput = messageBoard.querySelector('#guestbook-content');
    const signatureInput = messageBoard.querySelector('#guestbook-signature');
    const replyInput = messageBoard.querySelector('#guestbook-reply');
    const status = messageBoard.querySelector('[data-message-status]');
    const submitButton = form ? form.querySelector('button[type="submit"]') : null;
    const nextInput = form ? form.querySelector('[data-message-next]') : null;
    const replyToInput = form ? form.querySelector('[data-message-replyto]') : null;
    const submittedLocalInput = form ? form.querySelector('[data-message-submitted-local]') : null;
    const timezoneInput = form ? form.querySelector('[data-message-timezone]') : null;
    const formAction = form ? (form.getAttribute('action') || '').trim() : '';
    const hasAction = formAction.length > 0;
    const submitLabelDefault = submitButton ? (submitButton.getAttribute('data-label-default') || submitButton.textContent.trim() || 'ÂÜôÂ•Ω‰∫Ü') : 'ÂÜôÂ•Ω‰∫Ü';
    const submitLabelConfirm = submitButton ? (submitButton.getAttribute('data-label-confirm') || 'Á°ÆËÆ§Â•Ω‰∫ÜÔºÅ') : 'Á°ÆËÆ§Â•Ω‰∫ÜÔºÅ';
    let isAwaitingConfirm = false;

    const normalizeNickname = (value) => value.trim().replace(/\s+/g, ' ').slice(0, 24);
    const normalizeMessage = (value) => value.trim().slice(0, 500);
    const padDateNumber = (value) => String(value).padStart(2, '0');
    const formatLocalDateTime = (date) => {
      const year = date.getFullYear();
      const month = padDateNumber(date.getMonth() + 1);
      const day = padDateNumber(date.getDate());
      const hours = padDateNumber(date.getHours());
      const minutes = padDateNumber(date.getMinutes());
      const seconds = padDateNumber(date.getSeconds());
      return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    };
    const formatUTCOffset = (date) => {
      const offsetMinutes = -date.getTimezoneOffset();
      const sign = offsetMinutes >= 0 ? '+' : '-';
      const absoluteMinutes = Math.abs(offsetMinutes);
      const offsetHours = padDateNumber(Math.floor(absoluteMinutes / 60));
      const minutes = padDateNumber(absoluteMinutes % 60);
      return `UTC${sign}${offsetHours}:${minutes}`;
    };
    const getTimezoneName = () => {
      try {
        return Intl.DateTimeFormat().resolvedOptions().timeZone || '';
      } catch (error) {
        return '';
      }
    };

    const setStatus = (text, tone = 'normal') => {
      if (!status) return;
      status.dataset.tone = tone;
      status.textContent = '';
      if (!text) {
        status.hidden = true;
        return;
      }
      const lines = String(text).split('\n');
      lines.forEach((line, index) => {
        const lineNode = document.createElement('span');
        lineNode.className = 'message-board-status-line';
        lineNode.textContent = line;
        status.appendChild(lineNode);
        if (index < lines.length - 1) {
          status.appendChild(document.createElement('br'));
        }
      });
      status.hidden = false;
    };

    const setSubmitting = (isSubmitting) => {
      if (!submitButton) return;
      submitButton.disabled = isSubmitting;
      submitButton.setAttribute('aria-busy', isSubmitting ? 'true' : 'false');
    };

    const setConfirmState = (isConfirming) => {
      isAwaitingConfirm = !!isConfirming;
      if (!submitButton) return;
      submitButton.dataset.confirmPending = isAwaitingConfirm ? 'true' : 'false';
      submitButton.textContent = isAwaitingConfirm ? submitLabelConfirm : submitLabelDefault;
    };

    if (status) {
      status.hidden = true;
    }
    setConfirmState(false);

    const url = new URL(window.location.href);
    const isSent = url.searchParams.get('sent') === '1';
    if (isSent) {
      const sentMsRaw = url.searchParams.get('t');
      const sentMs = sentMsRaw ? Number(sentMsRaw) : NaN;
      const sentDate = Number.isFinite(sentMs) && sentMs > 0 ? new Date(sentMs) : new Date();
      const sentAtText = formatLocalDateTime(sentDate).replace(' ', '\u00A0');
      setStatus(`${sentAtText}\n‰ø°‰ª∂Â∑≤ÁªèÂØÑÂá∫‰∫ÜÔºÅ`, 'success');
      url.searchParams.delete('sent');
      url.searchParams.delete('t');
      window.history.replaceState({}, '', url.toString());
    }

    if (!hasAction) {
      if (form) {
        form.setAttribute('aria-disabled', 'true');
      }
      if (contentInput) contentInput.disabled = true;
      if (signatureInput) signatureInput.disabled = true;
      if (replyInput) replyInput.disabled = true;
      setSubmitting(true);
      setStatus('ËØ∑ÂÖàÂú®Á´ôÁÇπÈÖçÁΩÆ‰∏≠Â°´ÂÜôÈÇÆ‰ª∂Ë°®ÂçïÂú∞ÂùÄ„ÄÇ', 'error');
    } else if (form) {
      const clearConfirmStateForEdit = () => {
        if (!isAwaitingConfirm) return;
        setConfirmState(false);
        setStatus('‰øÆÊîπ‰øÆÊîπ‚Ä¶‚Ä¶', 'normal');
      };

      [contentInput, signatureInput, replyInput].forEach((input) => {
        if (!input) return;
        input.addEventListener('input', clearConfirmStateForEdit, { passive: true });
      });

      form.addEventListener('submit', async (event) => {
        const content = contentInput ? normalizeMessage(contentInput.value) : '';
        const signature = signatureInput ? (normalizeNickname(signatureInput.value) || 'È¶ôÁîúÁöÑÂπ¥ËΩÆËõãÁ≥ï') : 'È¶ôÁîúÁöÑÂπ¥ËΩÆËõãÁ≥ï';
        const replyAddress = replyInput ? replyInput.value.trim().slice(0, 120) : '';
        if (!content) {
          event.preventDefault();
          setStatus('ËØ∑Â°´ÂÜôÁïôË®ÄÂÜÖÂÆπ„ÄÇ', 'error');
          return;
        }

        if (nextInput) {
          const base = `${window.location.origin}${window.location.pathname}`;
          const nextURL = `${base}?sent=1&t=${Date.now()}`;
          nextInput.value = nextURL;
        }

        event.preventDefault();
        if (contentInput) contentInput.value = content;
        if (signatureInput) signatureInput.value = signature;
        if (replyInput) replyInput.value = replyAddress;

        if (!isAwaitingConfirm) {
          setConfirmState(true);
          setStatus('Á°ÆËÆ§ÂÜôÂ•Ω‰∫ÜÂêóÔºü', 'normal');
          return;
        }

        setConfirmState(false);
        setSubmitting(true);
        setStatus('Ê≠£Âú®ÂèëÈÄÅÔºåËØ∑Á®çÂÄô...', 'normal');

        try {
          const submittedAt = new Date();
          if (replyToInput) {
            replyToInput.value = replyAddress;
          }
          if (submittedLocalInput) {
            submittedLocalInput.value = `${formatLocalDateTime(submittedAt)} (${formatUTCOffset(submittedAt)})`;
          }
          if (timezoneInput) {
            const timezoneName = getTimezoneName();
            timezoneInput.value = timezoneName || formatUTCOffset(submittedAt);
          }

          const ajaxAction = formAction.includes('/ajax/')
            ? formAction
            : formAction.replace('://formsubmit.co/', '://formsubmit.co/ajax/');
          const payload = new FormData(form);
          const response = await fetch(ajaxAction, {
            method: 'POST',
            headers: {
              Accept: 'application/json'
            },
            body: payload
          });
          const result = await response.json().catch(() => ({}));

          if (!response.ok) {
            const errorText = (result && typeof result.message === 'string' && result.message.trim())
              ? result.message.trim()
              : `ÂèëÈÄÅÂ§±Ë¥•Ôºà${response.status}Ôºâ`;
            setStatus(errorText, 'error');
            return;
          }

          const sentAtText = formatLocalDateTime(new Date()).replace(' ', '\u00A0');
          setStatus(`${sentAtText}\n‰ø°‰ª∂Â∑≤ÁªèÂØÑÂá∫‰∫ÜÔºÅ`, 'success');
          if (contentInput) contentInput.value = '';
        } catch (error) {
          setStatus('ÂèëÈÄÅÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂêéÈáçËØï„ÄÇ', 'error');
        } finally {
          setSubmitting(false);
          if (submitButton && !isAwaitingConfirm) {
            submitButton.textContent = submitLabelDefault;
          }
        }
      });
    }
  }

</script>

{{ end }}
