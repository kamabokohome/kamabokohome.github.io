{{ define "main" }}

{{ $autoGallery := and (eq .Section "collection") (.Params.auto_gallery) }}

<article class="flex flex-col gap-5" style="flex: 1 1 auto;">
  <header class="flex flex-col">
    
<div class="meta">
  {{ if .PublishDate }}
    {{ $now := now }}
    {{ $today := $now.Format "2006-01-02" | time }}
    {{ $postDate := .PublishDate.Format "2006-01-02" | time }}
    {{ $days := div (sub $today.Unix $postDate.Unix) 86400 }}

    <time datetime="{{ .PublishDate }}" title='{{ .PublishDate.Format "01-02 15:04" }}'>
      {{ .PublishDate.Format "2006-01-02 15:04" }}
    </time>
  {{ end }}
</div>

    
    <h5 class="title-large">{{ .Title }}</h5>
    {{ if $autoGallery }}
      <div class="collection-layout-switch" role="group" aria-label="Collection layout switch">
        <button type="button" class="collection-layout-btn is-active" data-layout-target="single" title="ÂçïÂàó"><span class="collection-layout-emoji-run"><span class="collection-layout-emoji-unit">üç•</span></span></button>
        <button type="button" class="collection-layout-btn" data-layout-target="double" title="ÂèåÂàó"><span class="collection-layout-emoji-run"><span class="collection-layout-emoji-unit">üç•</span><span class="collection-layout-emoji-unit">üç•</span></span></button>
        <button type="button" class="collection-layout-btn" data-layout-target="triple" title="‰∏âÂàó"><span class="collection-layout-emoji-run"><span class="collection-layout-emoji-unit">üç•</span><span class="collection-layout-emoji-unit">üç•</span><span class="collection-layout-emoji-unit">üç•</span></span></button>
      </div>
    {{ end }}
  </header>

  {{ if not $autoGallery }}
    {{ partial "single/table-of-contents" . }}
  {{ end }}

  {{ if $autoGallery }}
    {{ $images := sort (.Resources.ByType "image") "Name" "desc" }}
    {{ $total := len $images }}
    {{ $lightboxPrev := resources.Get "icons/arrow-left.png" }}
    {{ $lightboxNext := resources.Get "icons/arrow-right.png" }}
    <section class="collection-auto-gallery" data-layout="single" aria-label="Auto gallery">
      <div class="collection-auto-grid">
        {{ range $idx, $image := $images }}
          {{ $imageName := $image.Name }}
          {{ $thumb := $image.Fit "1500x1500" }}
          {{ $caption := path.BaseName $image.Name }}
          {{ with $image.Exif }}
            {{ if ge .Date.Year 1900 }}
              {{ $caption = .Date.Format "2006-01-02 15:04" }}
            {{ end }}
          {{ end }}
          {{ with $.Params.image_captions }}
            {{ with index . $imageName }}
              {{ $caption = . }}
            {{ end }}
          {{ end }}
          {{ $no := printf "No.%03d" (sub $total $idx) }}
          {{ $label := printf "%s ¬∑ %s" $no $caption }}
          <article class="collection-codex-entry">
            <div class="collection-codex-meta">
              <div class="collection-codex-date"><span class="collection-codex-no">{{ $no }}</span> ¬∑ {{ $caption }}</div>
            </div>
            <figure class="collection-auto-item">
              <a
                href="{{ $image.RelPermalink }}"
                class="collection-auto-link"
                data-codex-zoom="1"
                data-codex-src="{{ $image.RelPermalink }}"
                data-codex-alt="{{ $.Title }} image"
                data-codex-caption="{{ $label }}"
              >
                <img
                  src="{{ $thumb.RelPermalink }}"
                  alt="{{ $.Title }} image"
                  width="{{ $thumb.Width }}"
                  height="{{ $thumb.Height }}"
                  loading="lazy"
                />
              </a>
            </figure>
          </article>
        {{ end }}
      </div>

      <div class="collection-lightbox" id="collectionLightbox" aria-hidden="true">
        <button class="collection-lightbox-nav collection-lightbox-prev" type="button" aria-label="Previous image">
          <img src="{{ $lightboxPrev.RelPermalink }}" alt="" aria-hidden="true" loading="lazy" />
        </button>
        <button class="collection-lightbox-nav collection-lightbox-next" type="button" aria-label="Next image">
          <img src="{{ $lightboxNext.RelPermalink }}" alt="" aria-hidden="true" loading="lazy" />
        </button>
        <button class="collection-lightbox-close" type="button" aria-label="Close image">√ó</button>
        <figure class="collection-lightbox-figure">
          <img class="collection-lightbox-image" src="" alt="" loading="eager" />
          <figcaption class="collection-lightbox-caption"></figcaption>
        </figure>
      </div>

      <script>
        document.addEventListener("DOMContentLoaded", function () {
          const gallery = document.querySelector(".collection-auto-gallery");
          const layoutButtons = Array.from(document.querySelectorAll(".collection-layout-btn[data-layout-target]"));
          const layoutStorageKey = "collection-layout:" + window.location.pathname;
          const allowedLayouts = ["single", "double", "triple"];

          const setLayout = function (layout) {
            if (!gallery || allowedLayouts.indexOf(layout) < 0) return;
            gallery.setAttribute("data-layout", layout);
            layoutButtons.forEach(function (button) {
              button.classList.toggle("is-active", button.getAttribute("data-layout-target") === layout);
            });
            try {
              window.localStorage.setItem(layoutStorageKey, layout);
            } catch (e) {}
          };

          if (gallery && layoutButtons.length > 0) {
            let initialLayout = "single";
            try {
              const stored = window.localStorage.getItem(layoutStorageKey);
              if (stored && allowedLayouts.indexOf(stored) >= 0) {
                initialLayout = stored;
              }
            } catch (e) {}
            setLayout(initialLayout);
            layoutButtons.forEach(function (button) {
              button.addEventListener("click", function () {
                const layout = button.getAttribute("data-layout-target");
                if (!layout) return;
                setLayout(layout);
                if (layout === "triple" && window.matchMedia("(max-width: 680px)").matches) {
                  const emojiRun = button.querySelector(".collection-layout-emoji-run");
                  if (!emojiRun) return;
                  emojiRun.classList.remove("is-wobble");
                  void emojiRun.offsetWidth;
                  emojiRun.classList.add("is-wobble");
                  window.setTimeout(function () {
                    emojiRun.classList.remove("is-wobble");
                  }, 520);
                }
              });
            });
          }

          const lightbox = document.getElementById("collectionLightbox");
          if (!lightbox) return;
          const links = Array.from(document.querySelectorAll("a[data-codex-zoom=\"1\"]"));
          const lightboxImage = lightbox.querySelector(".collection-lightbox-image");
          const lightboxCaption = lightbox.querySelector(".collection-lightbox-caption");
          const closeButton = lightbox.querySelector(".collection-lightbox-close");
          const prevButton = lightbox.querySelector(".collection-lightbox-prev");
          const nextButton = lightbox.querySelector(".collection-lightbox-next");
          if (!lightboxImage || !lightboxCaption || !closeButton || !prevButton || !nextButton || links.length === 0) return;
          let activeIndex = -1;

          const closeLightbox = function () {
            lightbox.classList.remove("is-open");
            lightbox.setAttribute("aria-hidden", "true");
            lightboxImage.src = "";
            lightboxImage.alt = "";
            lightboxCaption.textContent = "";
            activeIndex = -1;
            document.body.style.overflow = "";
          };

          const setLightboxByIndex = function (index) {
            const total = links.length;
            const safeIndex = ((index % total) + total) % total;
            activeIndex = safeIndex;
            const link = links[safeIndex];
            const src = link.getAttribute("data-codex-src");
            const alt = link.getAttribute("data-codex-alt");
            const caption = link.getAttribute("data-codex-caption");
            if (!src) return;
            lightboxImage.src = src;
            lightboxImage.alt = alt || "";
            lightboxCaption.textContent = caption || "";
          };

          const openLightboxByIndex = function (index) {
            setLightboxByIndex(index);
            lightbox.classList.add("is-open");
            lightbox.setAttribute("aria-hidden", "false");
            document.body.style.overflow = "hidden";
          };

          const stepLightbox = function (step) {
            if (!lightbox.classList.contains("is-open") || activeIndex < 0) return;
            setLightboxByIndex(activeIndex + step);
          };

          links.forEach(function (link, index) {
            link.addEventListener("click", function (event) {
              event.preventDefault();
              openLightboxByIndex(index);
            });
          });

          closeButton.addEventListener("click", closeLightbox);
          prevButton.addEventListener("click", function (event) {
            event.stopPropagation();
            stepLightbox(-1);
          });
          nextButton.addEventListener("click", function (event) {
            event.stopPropagation();
            stepLightbox(1);
          });
          lightbox.addEventListener("click", function (event) {
            if (event.target === lightbox) {
              closeLightbox();
            }
          });

          document.addEventListener("keydown", function (event) {
            if (!lightbox.classList.contains("is-open")) return;
            if (event.key === "Escape") {
              closeLightbox();
            } else if (event.key === "ArrowLeft") {
              stepLightbox(-1);
            } else if (event.key === "ArrowRight") {
              stepLightbox(1);
            }
          });
        });
      </script>
    </section>
  {{ else }}
    <section>{{ .Content | emojify }}</section>
  {{ end }}

  {{ if not $autoGallery }}
    {{ partial "single/comments/index" . }}
  {{ end }}

  <!--  
  <footer>
    {{ with (.GetTerms "tags") }}
      <div class="pb-14 taxonomy-list tags-list">
        {{ range . }}
          <a href="{{ .RelPermalink }}" alt="{{ .LinkTitle }}">
            {{ .LinkTitle }}
          </a>
        {{ end }}
      </div>
    {{ end }}
  </footer>
  -->

<!-- Previous and Next Post Buttons -->
<div class="flex items-center justify-between font-semibold w-full mt-4" style="margin-top: auto; padding-top: 1rem;">
  <!-- Previous post (left side). -->
  <div class="flex justify-start w-1/2">
    {{ $prev := .Prev }}
    {{ if and $prev (eq $prev.Section .Section) }}
      <a href="{{ $prev.RelPermalink }}" class="pagination-button" title="Ââç‰∏ÄÁØá">
        {{ $prevArrow := resources.Get "icons/arrow-left.png" }}
        <img src="{{ $prevArrow.RelPermalink }}" alt="Previous" style="width:32px; height:32px;" />
      </a>
    {{ else }}
      <a href="#" class="pagination-button pointer-events-none" title="Ê≤°ÊúâÂï¶">
        {{ $prevArrow := resources.Get "icons/arrow-left.png" }}
        <img src="{{ $prevArrow.RelPermalink }}" alt="Previous" style="width:32px; height:32px;"/>
      </a>
    {{ end }}
  </div>

<!-- JavaScript for Scrolling to Top -->
<script>
  function scrollToTop() {
    window.scrollTo({
      top: 0,
      behavior: 'smooth' // Smooth scrolling
    });
  }
</script>

<!-- Back to Top Button -->
<div class="flex justify-center mx-auto">
  <a href="#" onclick="scrollToTop()" class="text-xs font-semibold" style="color: #9CA3AF; text-decoration: none;">
    Tüç•P
  </a>
</div>

  <!-- Next post (right side). -->
  <div class="flex justify-end w-1/2">
    {{ $next := .Next }}
    {{ if and $next (eq $next.Section .Section) }}
      <a href="{{ $next.RelPermalink }}" class="pagination-button" title="Âêé‰∏ÄÁØá">
        {{ $nextArrow := resources.Get "icons/arrow-right.png" }}
        <img src="{{ $nextArrow.RelPermalink }}" alt="Next" style="width:32px; height:32px;" />
      </a>
    {{ else }}
      <a href="#" class="pagination-button pointer-events-none" title="Ê≤°ÊúâÂï¶">
        {{ $nextArrow := resources.Get "icons/arrow-right.png" }}
        <img src="{{ $nextArrow.RelPermalink }}" alt="Next" style="width:32px; height:32px;" />
      </a>
    {{ end }}
  </div>
</div>

</article>

{{ end }}
